<!doctype html>
<html xml:lang="zh-CN" lang="zh-CN">

<head>
        <link rel="canonical" href="https://clashnyanpasugithub.github.io/news/article-94073.htm" />
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>使用 LOAD DATA LOCAL INFILE，sysbench 导数速度提升30%</title>
        <meta name="description" content="最近给 sysbench 提了一个 feature（https://github.com/akopytov/sysbench/pull/450），支持通过 LOAD DATA LOCAL INFILE" />
        <link rel="icon" href="/assets/website/img/clashnyanpasugithub/favicon.ico" type="image/x-icon"/>

    <meta name="author" content="Clash Nyanpasu Github机场节点官网">
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://clashnyanpasugithub.github.io/news/article-94073.htm" />
    <meta property="og:site_name" content="Clash Nyanpasu Github机场节点官网" />
    <meta property="og:title" content="使用 LOAD DATA LOCAL INFILE，sysbench 导数速度提升30%" />
    <meta property="og:image" content="https://clashnyanpasugithub.github.io/uploads/20240820-1/60660919c6a878dad14067465a0ce0cb.webp" />
        <meta property="og:release_date" content="2025-04-12T08:54:24" />
    <meta property="og:updated_time" content="2025-04-12T08:54:24" />
        <meta property="og:description" content="最近给 sysbench 提了一个 feature（https://github.com/akopytov/sysbench/pull/450），支持通过 LOAD DATA LOCAL INFILE" />
        
    <!-- Template CSS -->
    <link rel="stylesheet" href="/assets/website/css/clashnyanpasugithub/style-starter.css">
    <!-- web fonts -->
    <link href="//fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">

    <meta name="applicable-device" content="pc,mobile" />
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta name="robots" content="max-image-preview:large" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="使用 LOAD DATA LOCAL INFILE，sysbench 导数速度提升30%">
    <meta name="format-detection" content="telephone=no">

    <link rel="dns-prefetch" href="https:/www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.googleadservices.com">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    <link rel="dns-prefetch" href="https://cm.g.doubleclick.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F1C52JTEWP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F1C52JTEWP');
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3332997411212854"
     crossorigin="anonymous"></script>
</head>

<body data-page="detail">
        <!--header-->
    <header id="site-header" class="fixed-top">
        <div class="container">
            <nav class="navbar navbar-expand-lg stroke">
                                <a class="navbar-brand" href="/">
                    <span>Clash Nyanpasu Github</span>
                </a>
                                <button class="navbar-toggler  collapsed bg-gradient" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon fa icon-expand fa-bars"></span>
                    <span class="navbar-toggler-icon fa icon-close fa-times"></span>
                    </span>
                </button>
                <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                    <ul class="navbar-nav ml-auto">
                                                <li class="nav-item">
                            <a class="nav-link" href="/">首页</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/free-nodes/">免费节点</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/paid-subscribe/">推荐机场</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/client.htm">客户端</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/news/">新闻资讯</a>
                        </li>
                                            </ul>
                </div>
            </nav>
        </div>
    </header>
    <!--/header-->
    <!-- about breadcrumbs -->
    <nav id="breadcrumbs" class="breadcrumbs">
        <div class="container page-wrapper">
            <a href="/">首页</a> » <a href="/news/">新闻资讯</a> » <span class="breadcrumb_last" aria-current="page">正文</span>
        </div>
    </nav>
    
    <!-- /index-block2 -->
    <section class="w3l-index3 py-5">
        <div class="container py-lg-3 mt-3">
            <div class="row">
                <div class="col-md-9">
                    <h1 class="mb-5">使用 LOAD DATA LOCAL INFILE，sysbench 导数速度提升30%</h1>
                                    <input type="hidden" id="share-website-info" data-name="" data-url="">
                  				  				  				<p data-tool="mdnice编辑器">最近给 sysbench 提了一个 feature（<a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=https://github.com/akopytov/sysbench/pull/450"  target="_blank" rel="nofollow">https://github.com/akopytov/sysbench/pull/450</a>），支持通过 LOAD DATA LOCAL INFILE 命令导入压测数据。</p> <p data-tool="mdnice编辑器">下面我们来具体看看这个 feature 的使用方法和实现细节。</p> <p data-tool="mdnice编辑器"> </h1> <p data-tool="mdnice编辑器">下载支持 LOAD DATA LOCAL INFILE 命令的 sysbench 分支。</p> <div class="cnblogs_code"> <pre>#<span style="color: rgba(0, 0, 255, 1)">yum</span> -y<span style="color: rgba(0, 0, 255, 1)">install</span><span style="color: rgba(0, 0, 255, 1)">make</span> automake libtool pkgconfig libaio-devel openssl-devel mysql-<span style="color: rgba(0, 0, 0, 1)">devel  # cd</span>/usr/src/<span style="color: rgba(0, 0, 0, 1)"> # git clone https:</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">github.com/slowtech/sysbench.git --branch feature-load-data</span> # cd sysbench/<span style="color: rgba(0, 0, 0, 1)"> # .</span>/autogen.<span style="color: rgba(0, 0, 255, 1)">sh</span><span style="color: rgba(0, 0, 0, 1)"> # .</span>/<span style="color: rgba(0, 0, 0, 1)">configure #</span><span style="color: rgba(0, 0, 255, 1)">make</span> -<span style="color: rgba(0, 0, 0, 1)">j #</span><span style="color: rgba(0, 0, 255, 1)">make</span><span style="color: rgba(0, 0, 255, 1)">install</span></pre> </div> <p data-tool="mdnice编辑器">安装完成后，压测脚本默认会安装在 /usr/local/share/sysbench 目录下。</p> <p data-tool="mdnice编辑器">我们看看该目录的内容。</p> <div class="cnblogs_code"> <pre>#<span style="color: rgba(0, 0, 255, 1)">ls</span> /usr/local/share/sysbench/<span style="color: rgba(0, 0, 0, 1)"> bulk_insert.lua  oltp_delete.lua  oltp_point_select.lua  oltp_read_write.lua    oltp_update_non_index.lua  select_random_points.lua  tests oltp_common.lua  oltp_insert.lua  oltp_read_only.lua     oltp_update_index.lua  oltp_write_only.lua        select_random_ranges.lua</span></pre> </div> <p data-tool="mdnice编辑器">除了oltp_common.lua是个公共模块，其它每个lua脚本都对应一个测试场景。</p> </h1> </h1> <p data-tool="mdnice编辑器">使用方法和 master 分支基本一致，主要是在 prepare 阶段新增了两个参数。</p> <p data-tool="mdnice编辑器">下面，我们看看 sysbench 压测 MySQL 的四个标准步骤：</p> <h3 data-tool="mdnice编辑器"><strong><span style="color: rgba(0, 128, 0, 1)">1. prepare</span></strong></h3> <p data-tool="mdnice编辑器">生成压测数据。</p> <div class="cnblogs_code"> <pre>sysbench oltp_read_write --mysql-host=<span style="color: rgba(128, 0, 128, 1)">10.0</span>.<span style="color: rgba(128, 0, 128, 1)">20.4</span> --mysql-port=<span style="color: rgba(128, 0, 128, 1)">3306</span> --mysql-user=root --mysql-password=<span style="color: rgba(128, 0, 128, 1)">123456</span> --mysql-db=sbtest --tables=<span style="color: rgba(128, 0, 128, 1)">10</span> --table-size=<span style="color: rgba(128, 0, 128, 1)">1000000</span> --threads=<span style="color: rgba(128, 0, 128, 1)">10</span> --fast --csv-<span style="color: rgba(0, 0, 255, 1)">dir</span>=/data/sysbench prepare</pre> </div> <p data-tool="mdnice编辑器">其中，</p> <ul class="list-paddingleft-1" data-tool="mdnice编辑器"> <li> <p>--tables ：表的数量，默认是1。</p> </li> <li> <p>--table-size ：单表的大小，默认是10000。</p> </li> <li> <p>--threads ：并发线程数，默认是1。注意，导入时，单表只能使用一个线程。</p> </li> <li> <p>oltp_read_write：脚本名。对应的是/usr/local/share/sysbench/oltp_read_write.lua。</p> <p>这里也可指定脚本的绝对路径。</p> </li> </ul> <p data-tool="mdnice编辑器">除此之外，这里还指定了新增的两个参数：</p> <ul class="list-paddingleft-1" data-tool="mdnice编辑器"> <li> <p>--fast：通过 LOAD DATA LOCAL INFILE 命令导入数据。不指定，则默认是使用 INSERT 命令导入数据。</p> </li> <li> <p>--csv-dir：CSV 文件的存储路径。不指定，则默认是 /tmp。</p> </li> </ul> <p data-tool="mdnice编辑器">如果使用的是 MySQL 8.0，在操作之前，需将 local_infile 设置为 ON，</p> <p data-tool="mdnice编辑器">否则，客户端在执行 LOAD DATA LOCAL INFILE 时会提示以下错误：</p> <div class="cnblogs_code"> <pre>ERROR<span style="color: rgba(128, 0, 128, 1)">3948</span> (<span style="color: rgba(128, 0, 128, 1)">42000</span>): Loading local data is disabled; this must be enabled on both the client and server sides</pre> </div> <p data-tool="mdnice编辑器">在 MySQL 5.6，5.7 中无需修改，该参数默认为 OFF。</p> <p data-tool="mdnice编辑器">最后，再来说说测试场景。</p> <p data-tool="mdnice编辑器">oltp_read_write 用来压测 OLTP 场景。</p> <p data-tool="mdnice编辑器">在 sysbench 1.0 之前， 该场景是通过 oltp.lua 这个脚本来测试的。</p> <p data-tool="mdnice编辑器">不过该脚本在 sysbench 1.0 之后被废弃了，为了跟之前的版本兼容，该脚本放到了 /usr/local/share/sysbench/tests/include/oltp_legacy/ 目录下。</p> <p data-tool="mdnice编辑器">鉴于 oltp_read_write.lua 和 oltp.lua 两者的压测内容完全一致。</p> <p data-tool="mdnice编辑器">从 sysbench 1.0 开始，压测 OLTP 建议直接使用 oltp_read_write。</p> <h3 data-tool="mdnice编辑器"><strong><span style="color: rgba(0, 128, 0, 1)">2. prewarm</span></strong></h3> <p data-tool="mdnice编辑器">预热。</p> <p data-tool="mdnice编辑器">主要是将磁盘中的数据加载到内存中。</p> <div class="cnblogs_code"> <pre>sysbench oltp_read_write --mysql-host=<span style="color: rgba(128, 0, 128, 1)">10.0</span>.<span style="color: rgba(128, 0, 128, 1)">20.4</span> --mysql-port=<span style="color: rgba(128, 0, 128, 1)">3306</span> --mysql-user=root --mysql-password=<span style="color: rgba(128, 0, 128, 1)">123456</span> --mysql-db=sbtest --tables=<span style="color: rgba(128, 0, 128, 1)">10</span> --table-size=<span style="color: rgba(128, 0, 128, 1)">1000000</span> --threads=<span style="color: rgba(128, 0, 128, 1)">10</span> prewarm</pre> </div> <h3 data-tool="mdnice编辑器"></h3> <h3 data-tool="mdnice编辑器"><strong><span style="color: rgba(0, 128, 0, 1)">3. run</span></strong></h3> <p data-tool="mdnice编辑器">压测。</p> <div class="cnblogs_code"> <pre>sysbench oltp_read_write --mysql-host=<span style="color: rgba(128, 0, 128, 1)">10.0</span>.<span style="color: rgba(128, 0, 128, 1)">20.4</span> --mysql-port=<span style="color: rgba(128, 0, 128, 1)">3306</span> --mysql-user=root --mysql-password=<span style="color: rgba(128, 0, 128, 1)">123456</span> --mysql-db=sbtest --tables=<span style="color: rgba(128, 0, 128, 1)">10</span> --table-size=<span style="color: rgba(128, 0, 128, 1)">1000000</span> --threads=<span style="color: rgba(128, 0, 128, 1)">10</span> --<span style="color: rgba(0, 0, 255, 1)">time</span>=<span style="color: rgba(128, 0, 128, 1)">600</span> --report-interval=<span style="color: rgba(128, 0, 128, 1)">10</span> run</pre> </div> <p data-tool="mdnice编辑器">其中，</p> <ul class="list-paddingleft-1" data-tool="mdnice编辑器"> <li>--time ：压测时间，不指定，则默认是10s。</li> <li>--report-interval=10 ：每10s输出一次压测结果，默认为0，不输出。</li> </ul> <h3 data-tool="mdnice编辑器"><strong><span style="color: rgba(0, 128, 0, 1)">4. cleanup</span></strong></h3> <p data-tool="mdnice编辑器">清理数据。</p> <div class="cnblogs_code"> <pre>sysbench oltp_read_write --mysql-host=<span style="color: rgba(128, 0, 128, 1)">10.0</span>.<span style="color: rgba(128, 0, 128, 1)">20.4</span> --mysql-port=<span style="color: rgba(128, 0, 128, 1)">3306</span> --mysql-user=root --mysql-password=<span style="color: rgba(128, 0, 128, 1)">123456</span> --mysql-db=sbtest --tables=<span style="color: rgba(128, 0, 128, 1)">10</span> cleanup<code><br/></code></pre> </div> <p data-tool="mdnice编辑器">这里只需指定 --tables ，sysbench 会串行执行 DROP TABLE IF EXISTS sbtest 操作。</p> </h1> </h1> <p data-tool="mdnice编辑器">下面对比了不同 tables（表的数量），table_size（表的大小），threads （并发线程数）下，LOAD 和 INSERT 操作所需的时间。</p> <p data-tool="mdnice编辑器">每个配置都会测试三次，LOAD 和 INSERT 操作交叉执行。</p> <p data-tool="mdnice编辑器">测试过程中，设置了 --create_secondary=false，不会创建二级索引，所以这里衡量的只是导入时间。</p> <p data-tool="mdnice编辑器">测试实例是甲骨文云上的 MDS （MySQL Database Service）。</p> <p data-tool="mdnice编辑器">配置相当强悍：16 OCPU（OCPU 是物理 CPU 核数，对应的逻辑 CPU 是 32 核），512G 内存，高性能块存储。</p> <p data-tool="mdnice编辑器">在测试的过程中，为了减轻磁盘 IO 的影响，将 sync_binlog 调整为了0。</p> <p data-tool="mdnice编辑器">下面我们看看测试结果。</p> <pre data-tool="mdnice编辑器"><code>+--------+------------+---------+---------------+-----------------+-------------------------------+<br/>|&nbsp;tables&nbsp;|&nbsp;table_size&nbsp;|&nbsp;threads&nbsp;|&nbsp;load_avg_time&nbsp;|&nbsp;insert_avg_time&nbsp;|&nbsp;load_avg_time/insert_avg_time&nbsp;|<br/>+--------+------------+---------+---------------+-----------------+-------------------------------+<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;58.03&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;82.95&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.70&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;117.52&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;169.00&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.70&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;68.85&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100.60&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.68&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;299.60&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;438.74&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.68&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;197.91&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;286.54&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.69&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;86.36&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;119.60&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.72&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;605.15&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;881.70&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.69&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;364.71&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;521.02&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.70&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;175.49&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;247.98&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.71&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;111.43&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;162.84&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.68&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1242.61&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1775.17&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.70&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;755.31&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1034.03&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.73&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;357.45&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;520.80&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.69&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;228.05&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;333.27&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.68&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;194.97&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;299.55&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.65&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1901.68&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2826.83&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.67&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1134.81&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1574.98&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.72&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;542.96&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;771.31&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.70&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;347.53&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;515.04&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.67&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;302.60&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;475.71&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.64&nbsp;|<br/>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;10000000&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;320.94&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;453.42&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.71&nbsp;|<br/>+--------+------------+---------+---------------+-----------------+-------------------------------+<br/></code></pre> <p data-tool="mdnice编辑器">结果中，</p> <p data-tool="mdnice编辑器">load_avg_time 是 LOAD 命令的平均执行时间。</p> <p data-tool="mdnice编辑器">insert_avg_time 是 INSERT 命令的平均执行时间。</p> <p data-tool="mdnice编辑器">最后一列是两者的比值。</p> <p data-tool="mdnice编辑器">可以看到，相同配置下，LOAD 命令的平均执行时间只有 INSERT 的 70% 。</p> <p data-tool="mdnice编辑器">下面，我们看看 tables = 30， table_size = 10000000 时，命令的执行时间与并发线程数之间的关系。</p> <p data-tool="mdnice编辑器"><img decoding="async" src="http://img.555519.xyz/uploads3/20220510/8658a51fc7fb127976d99b994cad95aa.jpg" alt="使用 LOAD DATA LOCAL INFILE，sysbench 导数速度提升30%"></p> <p data-tool="mdnice编辑器">可以看到，</p> <p data-tool="mdnice编辑器">并发数小于等于 5 时，随着并发线程数的增加，导入时间基本上是同比例下降。</p> <p data-tool="mdnice编辑器">当并发数超过 10 时，增加并发数带来的收益并不明显，甚至，LOAD 命令在 30 线程下的导入时间比 20 线程还高。</p> </h1> </h1> <p data-tool="mdnice编辑器">主要修改了两个文件：</p> <h3 data-tool="mdnice编辑器"><strong><span style="color: rgba(0, 128, 0, 1)">oltp_common.lua</span></strong></h3> <p data-tool="mdnice编辑器">lua 脚本的公共模块文件，位于源码包的 src/lua 目录下。</p> <p data-tool="mdnice编辑器">prepare的处理逻辑就是在这个文件中定义的。</p> <p data-tool="mdnice编辑器">我们直接看看新增代码的逻辑。</p> <div class="cnblogs_code"> <pre><span style="color: rgba(0, 0, 255, 1)">local</span><span style="color: rgba(0, 0, 0, 1)"> f</span><span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)"> 如果命令行中指定了 --fast，则打开一个文件。</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.fast)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 0, 0, 1)">     f</span>=<span style="color: rgba(255, 0, 255, 1)">assert</span>(<span style="color: rgba(255, 0, 255, 1)">io.open</span>(<span style="color: rgba(255, 0, 255, 1)">string.format</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">/%s/sbtest%d</span><span style="color: rgba(128, 0, 0, 1)">"</span>,sysbench.opt.csv_dir,table_num),<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">w</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">))</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 0, 255, 1)">for</span> i =<span style="color: rgba(128, 0, 128, 1)">1</span>, sysbench.opt.table_size<span style="color: rgba(0, 0, 255, 1)">do</span><span style="color: rgba(0, 0, 0, 1)">     c_val</span>=<span style="color: rgba(0, 0, 0, 1)"> get_c_value()    pad_val</span>=<span style="color: rgba(0, 0, 0, 1)"> get_pad_value()</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.auto_inc)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.fast)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)"> 构造字符串，字段与字段之间用逗号隔开，\n是换行符。</span>          query =<span style="color: rgba(255, 0, 255, 1)">string.format</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">%d,%s,%s\n</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,                             sysbench.rand.default(</span><span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">, sysbench.opt.table_size),                             c_val, pad_val)</span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">          query</span>=<span style="color: rgba(255, 0, 255, 1)">string.format</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">(%d, '%s', '%s')</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,                             sysbench.rand.default(</span><span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">, sysbench.opt.table_size),                             c_val, pad_val)</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.fast)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 0, 0, 1)">          query</span>=<span style="color: rgba(255, 0, 255, 1)">string.format</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">%d,%d,%s,%s\n</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,                             i,                             sysbench.rand.default(</span><span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">, sysbench.opt.table_size),                             c_val, pad_val)</span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">          query</span>=<span style="color: rgba(255, 0, 255, 1)">string.format</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">(%d, %d, '%s', '%s')</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,                             i,                             sysbench.rand.default(</span><span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">, sysbench.opt.table_size),                             c_val, pad_val)</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)"> 将构造的字符串写入到文件中</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.fast)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 0, 0, 1)">        f:write(query)</span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">       con:bulk_insert_next(query)</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.fast)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 0, 0, 1)">      f:close()</span><span style="color: rgba(0, 0, 255, 1)">local</span><span style="color: rgba(0, 0, 0, 1)"> column_name</span><span style="color: rgba(0, 0, 255, 1)">if</span> (sysbench.opt.auto_inc)<span style="color: rgba(0, 0, 255, 1)">then</span><span style="color: rgba(0, 0, 0, 1)">         column_name</span>=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">k, c, pad</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">         column_name</span>=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id, k, c, pad</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 255, 1)">end</span><span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)"> 通过 LOAD DATA LOCAL INFILE 命令导入数据</span>     query =<span style="color: rgba(255, 0, 255, 1)">string.format</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">LOAD DATA LOCAL INFILE '/%s/sbtest%d'</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)"> ..</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">INTO TABLE sbtest%d FIELDS TERMINATED BY ',' LINES TERMINATED BY '\\n'</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)"> ..</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">(%s)</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, sysbench.opt.csv_dir,table_num,table_num,column_name)</span><span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)"> 为了提升导入速度，这里在会话级别禁用了 unique_checks 和 foreign_key_checks</span>     con:query(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SET unique_checks = 0</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)     con:query(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SET foreign_key_checks = 0</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)     con:query(query)</span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">     con:bulk_insert_done()</span><span style="color: rgba(0, 0, 255, 1)">end</span></pre> </div> <h3 data-tool="mdnice编辑器"></h3> <h3 data-tool="mdnice编辑器"><strong><span style="color: rgba(0, 128, 0, 1)">drv_mysql.c</span></strong></h3> <p data-tool="mdnice编辑器">MySQL 驱动文件，位于源码包的 src/drivers/mysql 目录下。</p> <p data-tool="mdnice编辑器">在 MySQL 8.0 中，即使将服务端的 local_infile 设置为 ON，通过 mysql 客户端执行 LOAD DATA LOCAL INFILE 时，还是会报错。</p> <div class="cnblogs_code"> <pre>mysql<span style="color: rgba(128, 128, 128, 1)">&gt;</span><span style="color: rgba(0, 0, 255, 1)">LOAD</span> DATA LOCAL INFILE<span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(255, 0, 0, 1)">/data/sysbench/sbtest1</span><span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 255, 1)">INTO</span><span style="color: rgba(0, 0, 255, 1)">TABLE</span> sbtest1 FIELDS TERMINATED<span style="color: rgba(0, 0, 255, 1)">BY</span><span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(255, 0, 0, 1)">,</span><span style="color: rgba(255, 0, 0, 1)">'</span> LINES TERMINATED<span style="color: rgba(0, 0, 255, 1)">BY</span><span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(255, 0, 0, 1)">\n</span><span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)"> (k, c, pad); ERROR</span><span style="color: rgba(128, 0, 0, 1); font-weight: bold">2068</span> (HY000):<span style="color: rgba(0, 0, 255, 1)">LOAD</span> DATA LOCAL INFILE<span style="color: rgba(0, 0, 255, 1)">file</span> request rejected due<span style="color: rgba(0, 0, 255, 1)">to</span> restrictions<span style="color: rgba(0, 0, 255, 1)">on</span> access.</pre> </div> <p data-tool="mdnice编辑器">解决方法：</p> <p data-tool="mdnice编辑器">将 mysql 客户端的 local-infile 设置为 ON。</p> <div class="cnblogs_code"> <pre># mysql<span style="color: rgba(0, 128, 128, 1)">--</span><span style="color: rgba(0, 128, 128, 1)">local-infile=on</span></pre> </div> <p data-tool="mdnice编辑器">但在 sysbench 的 MySQL 驱动文件中，却没有这个选项。</p> <p data-tool="mdnice编辑器">好在 sysbench 使用的也是 C API，我们可以直接通过 mysql_options() 函数开启MYSQL_OPT_LOCAL_INFILE。</p> <div class="cnblogs_code"> <pre><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (args.use_local_infile) {   DEBUG(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">mysql_options(%p, %s, %d)</span><span style="color: rgba(128, 0, 0, 1)">"</span>,con,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">MYSQL_OPT_LOCAL_INFILE</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, args.use_local_infile);   mysql_options(con, MYSQL_OPT_LOCAL_INFILE,</span>&amp;<span style="color: rgba(0, 0, 0, 1)">args.use_local_infile); }</span></pre> </div> </h1> </h1> <p data-tool="mdnice编辑器">LOAD DATA INFILE 之所以比 INSERT 快，主要原因有以下几点：</p> <ol class="list-paddingleft-1" data-tool="mdnice编辑器"> <li> <p>无需解析 SQL 语句。</p> </li> <li> <p>一次会读取多个数据块。</p> </li> <li> <p>对于空表，操作期间会禁用所有非唯一索引。</p> </li> <li> <p>存储引擎会先缓存一些数据，达到一定数量后才批量插入（ MyISAM 和 Aria 存储引擎支持该行为）。</p> </li> <li> <p>对于空表，某些事务引擎（如 Aria）不会在事务日志中记录插入的数据。</p> <p>为什么不用记录呢？因为如果需要回滚，只需执行 TRUNCATE 操作即可。</p> </li> </ol> <p data-tool="mdnice编辑器">这里说的 Aria 是 MariaDB 中的一个存储引擎，主要用来替代 MyISAM 存储引擎。</p> <p data-tool="mdnice编辑器"> </h1> <ol class="list-paddingleft-1" data-tool="mdnice编辑器"> <li> <p>相同配置下，LOAD 命令的平均执行时间只有 INSERT 的 70% 。</p> </li> <li> <p>tables 和 table_size 一定时，在一定范围内，增加线程数能显著降低导入时间。</p> </li> <li> <p>在实际工作中，如果要导入的 CSV 文件很大，建议使用 MySQL Shell 中的 util.importTable。</p> <p>该命令在底层实现上使用的也是 LOAD DATA LOCAL INFILE，只不过它会将单个文件切割成多个 chunk 并行导入。</p> <p>相对来说，导入速度更快，也不会产生大事务。</p> </li> </ol> </h1> <p data-tool="mdnice编辑器"><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=https://mariadb.com/kb/en/how-to-quickly-insert-data-into-mariadb/"  target="_blank" rel="nofollow">How to Quickly Insert Data Into MariaDB</a></p> 			                <div class="clearfix"></div>
                <div class="col-md-12 mt-5">
                                        <p>上一个：<a href="/news/article-93672.htm">动物注射疫苗前后注意事项有哪些症状呢（动物打疫苗的作用）</a></p>
                                        <p>下一个：<a href="/news/article-94074.htm">动物接种疫苗的方法有哪些种类（动物接种途径有哪些）</a></p>
                                    </div>
                                </div>
                <div class="col-md-3">
                    <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">热门文章</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2"><a href="/news/article-76548.htm" title="看图识猫品种（看图识猫品种三花猫）">看图识猫品种（看图识猫品种三花猫）</a></li>
                        <li class="py-2"><a href="/news/article-91099.htm" title="动物疫苗厂家排名前十名有哪些品种 动物疫苗厂家排名前十名有哪些品种图片">动物疫苗厂家排名前十名有哪些品种 动物疫苗厂家排名前十名有哪些品种图片</a></li>
                        <li class="py-2"><a href="/news/article-87758.htm" title="延吉市宠物医院24小时营业 延吉市宠物医院24小时营业电话地址">延吉市宠物医院24小时营业 延吉市宠物医院24小时营业电话地址</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-4-10-free-subscribe-node.htm" title="「4月10日」最高速度22.4M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐">「4月10日」最高速度22.4M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐</a></li>
                        <li class="py-2"><a href="/news/article-75185.htm" title="出售动物疫苗需要什么手续（售卖兽用疫苗需要什么资质）">出售动物疫苗需要什么手续（售卖兽用疫苗需要什么资质）</a></li>
                        <li class="py-2"><a href="/news/article-71194.htm" title="农大动物医院有夜间急诊吗几点下班啊（农大动物医院有夜间急诊吗几点下班啊电话）">农大动物医院有夜间急诊吗几点下班啊（农大动物医院有夜间急诊吗几点下班啊电话）</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-3-4-node-share-links.htm" title="「3月4日」最高速度21.6M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐">「3月4日」最高速度21.6M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐</a></li>
                        <li class="py-2"><a href="/news/article-66654.htm" title="动物疫苗属于疫苗的分类吗为什么不能用（动物疫苗是什么单位）">动物疫苗属于疫苗的分类吗为什么不能用（动物疫苗是什么单位）</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-3-17-free-high-speed-nodes.htm" title="「3月17日」最高速度21M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐">「3月17日」最高速度21M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-3-31-free-clash-nyanpasu.htm" title="「3月31日」最高速度21.3M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐">「3月31日」最高速度21.3M/S，2025年Clash Nyanpasu免费机场订阅节点链接，2025翻墙机场推荐</a></li>
                    </ul>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">归纳</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">36</span> <a href="/date/2025-04/" title="2025-04 归档">2025-04</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">89</span> <a href="/date/2025-03/" title="2025-03 归档">2025-03</a></h4>
            </li>
                    </ul>
    </div>
</div>

                </div>
            </div>
        </div>
    </section>
        <footer>
        <!-- footer -->
        <section class="w3l-footer">
            <div class="w3l-footer-16-main py-5">
                <div class="container">
                    <div class="d-flex below-section justify-content-between align-items-center pt-4 mt-5">
                        <div class="columns text-lg-left text-center">
                                                <p>
                                                <a href="/">首页</a> |
                                                <a href="/free-nodes/">免费节点</a> |
                                                <a href="/paid-subscribe/">推荐机场</a> |
                                                <a href="/client.htm">客户端</a> |
                                                <a href="/news/">新闻资讯</a> |
                                                <a href="/about-us.htm">关于我们</a> |
                        <a href="/disclaimer.htm">免责申明</a> |
                        <a href="/privacy.htm">隐私申明</a> |
                        <a href="/sitemap.xml">网站地图</a>
                    </p>
                            <p>Clash Nyanpasu Github机场节点官网 版权所有 Powered by WordPress</p>
                        </div>
                        <div class="columns-2 mt-lg-0 mt-3">
                            <ul class="social">
                                <li><a href="#facebook"><span class="fa fa-facebook" aria-hidden="true"></span></a>
                                </li>
                                <li><a href="#linkedin"><span class="fa fa-linkedin" aria-hidden="true"></span></a>
                                </li>
                                <li><a href="#twitter"><span class="fa fa-twitter" aria-hidden="true"></span></a>
                                </li>
                                <li><a href="#google"><span class="fa fa-google-plus" aria-hidden="true"></span></a>
                                </li>
                                <li><a href="#github"><span class="fa fa-github" aria-hidden="true"></span></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- move top -->
            <button onclick="topFunction()" id="movetop" title="Go to top">
                <span class="fa fa-angle-up"></span>
            </button>
            <script>
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {
                scrollFunction()
            };

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById("movetop").style.display = "block";
                } else {
                    document.getElementById("movetop").style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
            }
            </script>
            <!-- //move top -->
            <script>
            $(function() {
                $('.navbar-toggler').click(function() {
                    $('body').toggleClass('noscroll');
                })
            });
            </script>
        </section>
        <!-- //footer -->
    </footer>
    <!-- jQuery JS -->
    <!-- <script src="/assets/website/js/frontend/clashnyanpasugithub/jquery-3.4.1.slim.min.js"></script> -->
    <!-- jQuery JS -->
    <script src="/assets/website/js/frontend/clashnyanpasugithub/jquery-3.5.1.min.js"></script>
    <!-- Template JavaScript -->
    <script src="/assets/website/js/frontend/clashnyanpasugithub/owl.carousel.js"></script>
    <!-- script for testimonials -->
    <script>
    $(document).ready(function() {
        $('.owl-two').owlCarousel({
            loop: true,
            margin: 0,
            nav: false,
            responsiveClass: true,
            autoplay: false,
            autoplayTimeout: 5000,
            autoplaySpeed: 1000,
            autoplayHoverPause: false,
            responsive: {
                0: {
                    items: 1,
                    nav: false
                },
                480: {
                    items: 1,
                    nav: false
                },
                667: {
                    items: 1,
                    nav: false
                },
                1000: {
                    items: 2,
                    nav: false
                }
            }
        })
    })
    </script>
    <!-- //testimonials owlcarousel -->
    <!-- script for customers -->
    <script>
    $(document).ready(function() {
        $('.owl-three').owlCarousel({
            loop: true,
            margin: 0,
            nav: false,
            responsiveClass: true,
            autoplay: true,
            autoplayTimeout: 5000,
            autoplaySpeed: 1000,
            autoplayHoverPause: false,
            responsive: {
                0: {
                    items: 1,
                    nav: false
                },
                480: {
                    items: 2,
                    nav: false
                },
                667: {
                    items: 2,
                    nav: false
                },
                1000: {
                    items: 4,
                    nav: false
                }
            }
        })
    })
    </script>
    <!-- //customers owlcarousel -->
    <!-- responsive tabs -->
    <script src="/assets/website/js/frontend/clashnyanpasugithub/easyResponsiveTabs.js"></script>
    <!--Plug-in Initialisation-->
    <script type="text/javascript">
    $(document).ready(function() {
        //Horizontal Tab
        $('#parentHorizontalTab').easyResponsiveTabs({
            type: 'default', //Types: default, vertical, accordion
            width: 'auto', //auto or any width like 600px
            fit: true, // 100% fit in a container
            tabidentify: 'hor_1', // The tab groups identifier
            activate: function(event) { // Callback function if tab is switched
                var $tab = $(this);
                var $info = $('#nested-tabInfo');
                var $name = $('span', $info);
                $name.text($tab.text());
                $info.show();
            }
        });
    });
    </script>
    <script src="/assets/website/js/frontend/clashnyanpasugithub/jquery.magnific-popup.min.js"></script>
    <script>
    $(document).ready(function() {
        $('.popup-with-zoom-anim').magnificPopup({
            type: 'inline',

            fixedContentPos: false,
            fixedBgPos: true,

            overflowY: 'auto',

            closeBtnInside: true,
            preloader: false,

            midClick: true,
            removalDelay: 300,
            mainClass: 'my-mfp-zoom-in'
        });

        $('.popup-with-move-anim').magnificPopup({
            type: 'inline',

            fixedContentPos: false,
            fixedBgPos: true,

            overflowY: 'auto',

            closeBtnInside: true,
            preloader: false,

            midClick: true,
            removalDelay: 300,
            mainClass: 'my-mfp-slide-bottom'
        });
    });
    </script>
    <!-- stats number counter-->
    <script src="/assets/website/js/frontend/clashnyanpasugithub/jquery.waypoints.min.js"></script>
    <script src="/assets/website/js/frontend/clashnyanpasugithub/jquery.countup.js"></script>
    <script>
    $('.counter').countUp();
    </script>
    <!-- //stats number counter -->
    <!--/MENU-JS-->
    <script>
    $(window).on("scroll", function() {
        var scroll = $(window).scrollTop();

        if (scroll >= 80) {
            $("#site-header").addClass("nav-fixed");
        } else {
            $("#site-header").removeClass("nav-fixed");
        }
    });

    //Main navigation Active Class Add Remove
    $(".navbar-toggler").on("click", function() {
        $("header").toggleClass("active");
    });
    $(document).on("ready", function() {
        if ($(window).width() > 991) {
            $("header").removeClass("active");
        }
        $(window).on("resize", function() {
            if ($(window).width() > 991) {
                $("header").removeClass("active");
            }
        });
    });
    </script>
    <!--//MENU-JS-->
    <!--  Bootstrap JS -->
    <script src="/assets/website/js/frontend/clashnyanpasugithub/bootstrap.min.js"></script>
    <script src="https://www.freeclashnode.com/assets/js/frontend/invite-url.js"></script><script src="/assets/website/js/frontend/G.js"></script>
</body>

</html>